{% extends "base.html" %}

{% block content %}
  <div class="center">
    <h2>[Make a New Post]</h2>
    <div class="new_reply">
      <form method="post">
        <table>
          <tr>
            <td><b>Name</b></td>
            <td><input class="input" type="text" placeholder="Anonymous" name="name"></td>
          <tr>
          <tr>
            <td><b>Subject</b></td>
            <td><input class="input" type="text" name="subject"></td>
          <tr>
          <tr>
            <td><b>Comment</b></td>
            <td><textarea class="input" name="text"></textarea></td>
          </tr>
        </table>
        <input type="submit" value="Post">
      </form>
    </div>
  </div>
  <hr>
  {% for thread in threads %}
    {%
      set replies=db.execute(
        "SELECT * FROM replies"
        " WHERE thread_id=?"
        " ORDER BY id ASC"
        " LIMIT 5",
        (thread["id"],)
      ).fetchall()
    %}
    <div class="thread">
      <div class="body">
        <div class="time">
          <b><span style="color: #ff00ff;">{{ thread["subject"] }}</span> {{ replies[0]["name"] }}</b>
          {{ replies[0]["created"].strftime("%d/%m/%y (%a) %H:%M:%S") }} No.{{ replies[0]["id"] }}
        </div>
        <div class="text">
          {{ replies[0]["text"] }}
        </div>
      </div>
    </div>
    {% if replies|length > 4 %}
      {{
        (replies|length - 3) }} repl{{ "ies" if replies|length > 4 else "y"
      }} omitted. <a href="thread/{{ replies[0]['id'] }}">Click here</a> to view.
      {%
        set replies=db.execute(
          "SELECT * FROM"
          " ("
          "  SELECT * FROM replies"
          "  WHERE thread_id=?"
          "  ORDER BY id DESC"
          "  LIMIT 3"
          " )"
          " ORDER BY id ASC",
          (thread["id"],)
        ).fetchall()
      %}
      {% for reply in replies %}
        {% include "reply.html" %}
      {% endfor %}
    {% else %}
      {% for reply in replies[1:4] %}
        {% include "reply.html" %}
      {% endfor %}
    {% endif %}
    <hr>
  {% endfor %}
{% endblock %}
